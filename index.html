<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>مدیریت پراکسی‌های تلگرام</title>
<!-- بوت‌استرپ -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body {
    background-color: #f0f2f5;
    font-family: "Vazir", Tahoma, sans-serif;
    padding: 20px;
  }
  .proxy-item {
    padding: 12px 16px;
    border-radius: 8px;
    background: white;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 5px rgb(0 0 0 / 0.1);
    flex-wrap: wrap;
  }
  .proxy-status {
    min-width: 100px;
    text-align: center;
    font-weight: 600;
  }
  .status-active {
    color: #198754;
  }
  .status-inactive {
    color: #dc3545;
  }
  .toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1055;
  }
</style>
</head>
<body>

<div class="container">
  <h1 class="mb-4">مدیریت پراکسی‌های تلگرام</h1>

  <div class="mb-3 d-flex flex-wrap gap-2">
    <button id="update-btn" class="btn btn-primary">آپدیت لیست</button>
    <input id="search-input" type="search" class="form-control w-auto" placeholder="جستجوی پراکسی..." />
    <select id="filter-status" class="form-select w-auto">
      <option value="all" selected>همه پراکسی‌ها</option>
      <option value="active">فقط فعال‌ها</option>
      <option value="inactive">فقط غیرفعال‌ها</option>
      <option value="untested">تست نشده</option>
    </select>
  </div>

  <div class="mb-2">
    <span id="count-total">0 پراکسی</span> | 
    <span id="count-active" class="text-success">0 فعال</span> | 
    <span id="count-inactive" class="text-danger">0 غیرفعال</span> | 
    <span id="count-untested">0 تست نشده</span>
  </div>

  <div id="proxy-list" class="list-group">
    در حال بارگذاری...
  </div>
</div>

<!-- Toast پیام کپی -->
<div class="toast-container position-fixed top-0 end-0 p-3">
  <div id="copy-toast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">کپی شد!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="بستن"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const proxyListEl = document.getElementById('proxy-list');
  const updateBtn = document.getElementById('update-btn');
  const searchInput = document.getElementById('search-input');
  const filterStatus = document.getElementById('filter-status');

  const countTotal = document.getElementById('count-total');
  const countActive = document.getElementById('count-active');
  const countInactive = document.getElementById('count-inactive');
  const countUntested = document.getElementById('count-untested');

  // جایگزین کن لینک raw فایل پراکسی خودت رو اینجا
  const proxySourceURL = 'https://raw.githubusercontent.com/hookzof/socks5_list/master/tg/mtproto.json';

  // آرایه پراکسی‌ها به شکل آبجکت {full, status}
  let proxies = [];

  // تابع برای تجزیه پراکسی به بخش‌ها (ip, port, user, pass)
  function parseProxy(proxyStr) {
    const parts = proxyStr.split(':');
    return {
      ip: parts[0] || '',
      port: parts[1] || '',
      user: parts[2] || '',
      pass: parts[3] || '',
      full: proxyStr,
      status: 'untested' // مقدار اولیه تست نشده
    };
  }

  function createConnectLink(proxy) {
    let url = `tg://socks?server=${proxy.ip}&port=${proxy.port}`;
    if(proxy.user) url += `&user=${encodeURIComponent(proxy.user)}`;
    if(proxy.pass) url += `&pass=${encodeURIComponent(proxy.pass)}`;
    return url;
  }

  function createProxyItem(proxyObj) {
    const item = document.createElement('div');
    item.className = 'proxy-item list-group-item d-flex justify-content-between align-items-center flex-wrap';

    const infoDiv = document.createElement('div');
    infoDiv.style.minWidth = '250px';

    const mainText = document.createElement('div');
    mainText.textContent = `${proxyObj.ip}:${proxyObj.port}`;
    infoDiv.appendChild(mainText);

    if(proxyObj.user) {
      const userText = document.createElement('small');
      userText.textContent = `کاربر: ${proxyObj.user}`;
      userText.style.color = '#555';
      infoDiv.appendChild(userText);
    }
    if(proxyObj.pass) {
      const passText = document.createElement('small');
      passText.textContent = `رمز: ${proxyObj.pass}`;
      passText.style.color = '#555';
      infoDiv.appendChild(passText);
    }

    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'd-flex align-items-center gap-2 mt-2 mt-sm-0';

    // دکمه کپی کل پراکسی
    const copyBtn = document.createElement('button');
    copyBtn.className = 'btn btn-sm btn-outline-primary';
    copyBtn.textContent = 'کپی کل';
    copyBtn.onclick = () => {
      navigator.clipboard.writeText(proxyObj.full).then(() => {
        showToast('کپی شد!');
      });
    };

    // دکمه اتصال به تلگرام
    const connectBtn = document.createElement('button');
    connectBtn.className = 'btn btn-sm btn-outline-success';
    connectBtn.textContent = 'اتصال';
    connectBtn.onclick = () => {
      const url = createConnectLink(proxyObj);
      window.location.href = url;
    };

    buttonsDiv.appendChild(copyBtn);
    buttonsDiv.appendChild(connectBtn);

    item.appendChild(infoDiv);
    item.appendChild(buttonsDiv);

    return item;
  }

  function renderList() {
    const search = searchInput.value.trim();
    const filter = filterStatus.value;

    const filtered = proxies.filter(p => {
      const matchSearch = p.full.includes(search);
      const matchFilter = filter === 'all' || p.status === filter || (filter === 'untested' && (!p.status || p.status === 'untested'));
      return matchSearch && matchFilter;
    });

    proxyListEl.innerHTML = '';
    if(filtered.length === 0) {
      proxyListEl.textContent = 'هیچ پراکسی‌ای یافت نشد.';
      return;
    }

    filtered.forEach(p => {
      proxyListEl.appendChild(createProxyItem(p));
    });

    countTotal.textContent = `${proxies.length} پراکسی`;
    countActive.textContent = `${proxies.filter(p => p.status === 'active').length} فعال`;
    countInactive.textContent = `${proxies.filter(p => p.status === 'inactive').length} غیرفعال`;
    countUntested.textContent = `${proxies.filter(p => !p.status || p.status === 'untested').length} تست نشده`;
  }

  async function fetchProxies() {
    proxyListEl.textContent = 'در حال بارگذاری...';
    try {
      const res = await fetch(proxySourceURL);
      if(!res.ok) throw new Error('خطا در دریافت لیست');
      const text = await res.text();
      const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
      proxies = lines.map(line => {
        const obj = parseProxy(line);
        // وضعیت همه رو تست نشده بگذار
        obj.status = 'untested';
        return obj;
      });
      renderList();
    } catch(e) {
      proxyListEl.textContent = 'خطا در بارگذاری پراکسی‌ها: ' + e.message;
    }
  }

  const toastEl = document.getElementById('copy-toast');
  const toast = new bootstrap.Toast(toastEl);
  function showToast(msg) {
    toastEl.querySelector('.toast-body').textContent = msg;
    toast.show();
  }

  updateBtn.onclick = fetchProxies;
  searchInput.oninput = renderList;
  filterStatus.onchange = renderList;

  fetchProxies();
</script>
</body>
</html>
